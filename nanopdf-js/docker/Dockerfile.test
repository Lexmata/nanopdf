# Multi-stage Dockerfile for testing nanopdf-js
# Builds the Rust library and tests Node.js bindings with N-API

# Stage 1: Build the Rust library
FROM rust:1.87-bookworm AS rust-builder

WORKDIR /build

# Copy Rust project
COPY nanopdf-rs/ ./nanopdf-rs/

# Build the Rust library
WORKDIR /build/nanopdf-rs
RUN cargo build --release

# Stage 2: Node.js testing environment
FROM node:22-bookworm

# Install build dependencies for node-gyp
RUN apt-get update && apt-get install -y \
    build-essential \
    python3 \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm globally
RUN npm install -g pnpm

# Set working directory
WORKDIR /workspace

# Copy the Rust library from builder stage
COPY --from=rust-builder /build/nanopdf-rs/target/release/libnanopdf.a /usr/local/lib/
COPY --from=rust-builder /build/nanopdf-rs/include/ /usr/local/include/

# Copy Node.js project
COPY nanopdf-js/ ./nanopdf-js/

# Set working directory to Node.js project
WORKDIR /workspace/nanopdf-js

# Create lib directories for native addon
RUN mkdir -p native/lib/linux-x64 && \
    cp /usr/local/lib/libnanopdf.a native/lib/linux-x64/

# Copy headers to native include directory
RUN mkdir -p native/include && \
    cp -r /usr/local/include/* native/include/

# Install dependencies
RUN pnpm install --frozen-lockfile

# Build TypeScript
RUN pnpm run build:ts

# Build native addon
RUN pnpm run build:native

# Environment variables
ENV NODE_ENV=test

# Default command: run all tests
CMD ["sh", "-c", "\
    echo '=====================================' && \
    echo 'Testing nanopdf-js' && \
    echo '=====================================' && \
    echo '' && \
    echo '==> Node.js version:' && \
    node --version && \
    echo '' && \
    echo '==> pnpm version:' && \
    pnpm --version && \
    echo '' && \
    echo '==> Checking native addon...' && \
    node -e \"const addon = require('./build/Release/nanopdf_native.node'); console.log('✓ Native addon loaded:', Object.keys(addon).length, 'exports');\" && \
    echo '' && \
    echo '==> Running unit tests...' && \
    pnpm test && \
    echo '' && \
    echo '==> Running integration tests...' && \
    pnpm test -- --run integration && \
    echo '' && \
    echo '==> Building TypeScript...' && \
    pnpm run build:ts && \
    echo '' && \
    echo '==> Type checking...' && \
    pnpm exec tsc --noEmit && \
    echo '' && \
    echo '=====================================' && \
    echo '✓ All tests passed!' && \
    echo '=====================================' \
"]

