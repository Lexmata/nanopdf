name: Benchmarks

on:
  push:
    branches: [main]
    paths:
      - 'nanopdf-rs/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  pull_request:
    branches: [main]
    paths:
      - 'nanopdf-rs/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  workflow_dispatch:

permissions:
  contents: write
  deployments: write

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            nanopdf-rs/target/
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-

      - name: Run benchmarks
        working-directory: nanopdf-rs
        run: |
          cargo bench --all-features -- --save-baseline main 2>&1 | tee benchmark-output.txt

      - name: Parse benchmark results
        id: bench
        working-directory: nanopdf-rs
        run: |
          # Create JSON output for benchmark action
          echo '{"name": "NanoPDF Rust Benchmarks", "date": "'$(date -Iseconds)'", "benches": [' > bench-results.json

          # Parse criterion output
          grep -E "^[a-zA-Z_/]+\s+time:" benchmark-output.txt | while read line; do
            name=$(echo "$line" | cut -d' ' -f1)
            time=$(echo "$line" | grep -oP '\d+\.?\d*\s*(ns|¬µs|ms|s)' | head -1)
            value=$(echo "$time" | grep -oP '\d+\.?\d*')
            unit=$(echo "$time" | grep -oP '(ns|¬µs|ms|s)')

            # Convert to nanoseconds for consistency
            case $unit in
              s) value=$(echo "$value * 1000000000" | bc) ;;
              ms) value=$(echo "$value * 1000000" | bc) ;;
              ¬µs) value=$(echo "$value * 1000" | bc) ;;
            esac

            echo "{\"name\": \"$name\", \"value\": $value, \"unit\": \"ns\"}," >> bench-results.json
          done

          # Remove trailing comma and close JSON
          sed -i '$ s/,$//' bench-results.json
          echo ']}' >> bench-results.json

          # Fallback if no benchmarks found
          if [ ! -s bench-results.json ] || [ $(wc -l < bench-results.json) -lt 3 ]; then
            echo '{"name": "NanoPDF Rust Benchmarks", "date": "'$(date -Iseconds)'", "benches": [{"name": "placeholder", "value": 0, "unit": "ns"}]}' > bench-results.json
          fi

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: NanoPDF Rust Benchmarks
          tool: 'customSmallerIsBetter'
          output-file-path: nanopdf-rs/bench-results.json
          # Push to gh-pages branch
          auto-push: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # Alert if performance regresses by more than 20%
          alert-threshold: '120%'
          comment-on-alert: true
          fail-on-alert: false
          # Store benchmark history
          benchmark-data-dir-path: dev/bench
          # Save Criterion HTML reports
          external-data-json-path: nanopdf-rs/criterion-report.json

      - name: Prepare Criterion HTML reports for GitHub Pages
        run: |
          # Create directory for criterion reports
          mkdir -p gh-pages-criterion

          # Copy criterion HTML reports
          if [ -d "nanopdf-rs/target/criterion" ]; then
            cp -r nanopdf-rs/target/criterion gh-pages-criterion/

            # Create index page for criterion reports
            cat > gh-pages-criterion/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>NanoPDF Benchmarks - Criterion Reports</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
              }
              h1 { color: #333; }
              .nav {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                margin-bottom: 20px;
              }
              .nav a {
                display: inline-block;
                margin: 5px 10px;
                padding: 10px 20px;
                background: #0066cc;
                color: white;
                text-decoration: none;
                border-radius: 4px;
              }
              .nav a:hover { background: #0052a3; }
              .benchmarks {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
              }
              .benchmark {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              .benchmark h3 { margin-top: 0; color: #0066cc; }
              .benchmark a { color: #0066cc; text-decoration: none; }
              .benchmark a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>üöÄ NanoPDF Performance Benchmarks</h1>

            <div class="nav">
              <h2>üìä Quick Links</h2>
              <a href="../dev/bench/">Historical Trends</a>
              <a href="criterion/report/index.html">Full Criterion Report</a>
              <a href="https://github.com/Lexmata/nanopdf">GitHub Repository</a>
            </div>

            <h2>üì¶ Benchmark Suites</h2>
            <div class="benchmarks">
              <div class="benchmark">
                <h3>üé® Core Graphics</h3>
                <ul>
                  <li><a href="criterion/geometry/report/index.html">Geometry</a> - Matrix, Point, Rect, Quad</li>
                  <li><a href="criterion/path/report/index.html">Path</a> - Path operations</li>
                  <li><a href="criterion/device/report/index.html">Device</a> - Device operations</li>
                  <li><a href="criterion/pixmap/report/index.html">Pixmap</a> - Pixel operations</li>
                </ul>
              </div>

              <div class="benchmark">
                <h3>üìù Text & Fonts</h3>
                <ul>
                  <li><a href="criterion/font/report/index.html">Font</a> - Font operations</li>
                  <li><a href="criterion/text/report/index.html">Text</a> - Text layout & rendering</li>
                </ul>
              </div>

              <div class="benchmark">
                <h3>üñºÔ∏è Images & Colors</h3>
                <ul>
                  <li><a href="criterion/image/report/index.html">Image</a> - Image processing</li>
                  <li><a href="criterion/colorspace/report/index.html">Colorspace</a> - Color conversions</li>
                </ul>
              </div>

              <div class="benchmark">
                <h3>üíæ I/O & Streams</h3>
                <ul>
                  <li><a href="criterion/buffer/report/index.html">Buffer</a> - Buffer operations</li>
                  <li><a href="criterion/stream/report/index.html">Stream</a> - Stream I/O</li>
                  <li><a href="criterion/output/report/index.html">Output</a> - Output streams</li>
                </ul>
              </div>

              <div class="benchmark">
                <h3>üìÑ PDF Features</h3>
                <ul>
                  <li><a href="criterion/pdf_objects/report/index.html">PDF Objects</a> - Object operations</li>
                  <li><a href="criterion/filters/report/index.html">Filters</a> - Encode/decode</li>
                  <li><a href="criterion/archive/report/index.html">Archive</a> - ZIP/TAR parsing</li>
                </ul>
              </div>
            </div>

            <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666;">
              <p>Last updated: $(date)</p>
              <p>Commit: ${{ github.sha }}</p>
            </footer>
          </body>
          </html>
          EOF
          fi

      - name: Deploy Criterion reports to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-criterion
          destination_dir: criterion-reports
          keep_files: false

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            nanopdf-rs/benchmark-output.txt
            nanopdf-rs/bench-results.json
            nanopdf-rs/target/criterion/
          retention-days: 30

  # Compare PR benchmarks against main
  benchmark-compare:
    name: Compare Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            nanopdf-rs/target/
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Install critcmp
        run: cargo install critcmp || true

      - name: Checkout base branch
        run: git checkout ${{ github.base_ref }}

      - name: Run base benchmarks
        working-directory: nanopdf-rs
        run: cargo bench --all-features -- --save-baseline base

      - name: Checkout PR branch
        run: git checkout ${{ github.head_ref }}

      - name: Run PR benchmarks
        working-directory: nanopdf-rs
        run: cargo bench --all-features -- --save-baseline pr

      - name: Compare benchmarks
        working-directory: nanopdf-rs
        id: compare
        run: |
          echo "## Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Comparing \`${{ github.base_ref }}\` (base) vs \`${{ github.head_ref }}\` (PR)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          critcmp base pr 2>&1 | tee -a $GITHUB_STEP_SUMMARY || echo "No benchmark comparison available"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');

            // Read comparison results
            let comparison = '';
            try {
              const { execSync } = require('child_process');
              comparison = execSync('cd nanopdf-rs && critcmp base pr 2>&1 || echo "No comparison available"', { encoding: 'utf8' });
            } catch (e) {
              comparison = 'Benchmark comparison not available';
            }

            const body = `## üìä Benchmark Results

            <details>
            <summary>Click to expand benchmark comparison</summary>

            \`\`\`
            ${comparison}
            \`\`\`

            </details>

            *Comparing \`${{ github.base_ref }}\` (base) vs \`${{ github.head_ref }}\` (PR)*
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.body.includes('üìä Benchmark Results'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
