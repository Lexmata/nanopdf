name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Detect which projects have changes
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      nodejs: ${{ steps.filter.outputs.nodejs }}
      go: ${{ steps.filter.outputs.go }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - 'nanopdf-rs/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            nodejs:
              - 'nanopdf-js/**'
            go:
              - 'go-nanopdf/**'
            docker:
              - 'nanopdf-rs/docker/**'

  # Rust library tests
  test-rust:
    name: Rust Tests (${{ matrix.os }}, ${{ matrix.rust }})
    needs: changes
    if: ${{ needs.changes.outputs.rust == 'true' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, beta]
        exclude:
          - os: macos-latest
            rust: beta
          - os: windows-latest
            rust: beta

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            nanopdf-rs/target/
          key: ${{ runner.os }}-cargo-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.rust }}-

      - name: Build
        working-directory: nanopdf-rs
        run: cargo build --verbose

      - name: Run tests
        working-directory: nanopdf-rs
        run: cargo test --verbose

      - name: Run tests (all features)
        working-directory: nanopdf-rs
        run: cargo test --verbose --all-features

  # Rust linting
  lint-rust:
    name: Rust Lint
    needs: changes
    if: ${{ needs.changes.outputs.rust == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Check formatting
        working-directory: nanopdf-rs
        run: cargo fmt --all -- --check

      - name: Clippy
        working-directory: nanopdf-rs
        run: cargo clippy --all-targets --all-features -- -D warnings

  # Rust documentation
  docs-rust:
    name: Rust Documentation
    needs: changes
    if: ${{ needs.changes.outputs.rust == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Build docs
        working-directory: nanopdf-rs
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

  # Rust code coverage
  coverage-rust:
    name: Rust Coverage
    needs: changes
    if: ${{ needs.changes.outputs.rust == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage
        working-directory: nanopdf-rs
        run: cargo tarpaulin --verbose --all-features --workspace --timeout 120 --out xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: nanopdf-rs/cobertura.xml
          flags: rust
          fail_ci_if_error: false

  # Node.js bindings tests
  test-nodejs:
    name: Node.js Tests
    needs: changes
    if: ${{ needs.changes.outputs.nodejs == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        working-directory: nanopdf-js
        run: pnpm install --ignore-scripts

      - name: Build TypeScript
        working-directory: nanopdf-js
        run: pnpm run build:ts

      - name: Run tests
        working-directory: nanopdf-js
        run: pnpm test

  # Node.js linting
  lint-nodejs:
    name: Node.js Lint
    needs: changes
    if: ${{ needs.changes.outputs.nodejs == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        working-directory: nanopdf-js
        run: pnpm install --ignore-scripts

      - name: Check TypeScript
        working-directory: nanopdf-js
        run: pnpm run typecheck || true

  # Go bindings tests
  test-go:
    name: Go Tests
    needs: changes
    if: ${{ needs.changes.outputs.go == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run tests (mock mode)
        working-directory: go-nanopdf
        run: CGO_ENABLED=0 go test -v ./...

  # Go linting
  lint-go:
    name: Go Lint
    needs: changes
    if: ${{ needs.changes.outputs.go == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          working-directory: go-nanopdf
          version: latest

  # Docker build test
  docker-build:
    name: Docker Build Test
    needs: changes
    if: ${{ needs.changes.outputs.docker == 'true' || needs.changes.outputs.rust == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Debian image (${{ matrix.platform }})
        uses: docker/build-push-action@v5
        with:
          context: ./nanopdf-rs
          file: nanopdf-rs/docker/Dockerfile.debian
          platforms: ${{ matrix.platform }}
          push: false
          tags: nanopdf:debian-test-${{ matrix.platform }}
          cache-from: type=gha,scope=${{ matrix.platform }}-debian
          cache-to: type=gha,mode=max,scope=${{ matrix.platform }}-debian

      - name: Build RPM image (${{ matrix.platform }})
        uses: docker/build-push-action@v5
        with:
          context: ./nanopdf-rs
          file: nanopdf-rs/docker/Dockerfile.redhat
          platforms: ${{ matrix.platform }}
          push: false
          tags: nanopdf:rpm-test-${{ matrix.platform }}
          cache-from: type=gha,scope=${{ matrix.platform }}-rpm
          cache-to: type=gha,mode=max,scope=${{ matrix.platform }}-rpm

  # Summary job - always runs to provide status
  ci-status:
    name: CI Status
    if: always()
    needs: [changes, test-rust, lint-rust, docs-rust, coverage-rust, test-nodejs, lint-nodejs, test-go, lint-go, docker-build]
    runs-on: ubuntu-latest
    steps:
      - name: Check status
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Projects" >> $GITHUB_STEP_SUMMARY
          echo "- Rust: ${{ needs.changes.outputs.rust }}" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js: ${{ needs.changes.outputs.nodejs }}" >> $GITHUB_STEP_SUMMARY
          echo "- Go: ${{ needs.changes.outputs.go }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: ${{ needs.changes.outputs.docker }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any required job failed
          if [[ "${{ needs.test-rust.result }}" == "failure" ]] || \
             [[ "${{ needs.lint-rust.result }}" == "failure" ]] || \
             [[ "${{ needs.test-nodejs.result }}" == "failure" ]] || \
             [[ "${{ needs.test-go.result }}" == "failure" ]]; then
            echo "❌ Some jobs failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "✅ All jobs passed or were skipped!" >> $GITHUB_STEP_SUMMARY
